create   proc [stage].[prcLoadVendInvoiceJour] as 
begin 
--This proc is automatically created by [etl].[prcMaterializeExternalData]

DELETE t from dbo.VendInvoiceJour t 
where exists 
	(select 1 from stage.VendInvoiceJour s 
	 where s.recid=t.recid 
		and (s.DML_Action='DELETE')
		and isnull(t.LSN,'')<isnull(s.Start_LSN,'')--delete the older record
	)

MERGE dbo.VendInvoiceJour with(tablock) as t
using (select * from blobTransInc.VendInvoiceJour where DML_Action<>'DELETE' and Instance=1) as s
on (s.recid=t.recid)
when matched then update set 
	[AttorneyDate_RU]=s.[AttorneyDate_RU],[AttorneyId_RU]=s.[AttorneyId_RU],[AttorneyIssuedName_RU]=s.[AttorneyIssuedName_RU],[BankLCImportLine]=s.[BankLCImportLine],[CashDisc]=s.[CashDisc],[CashDiscCode]=s.[CashDiscCode],[CashDiscDate]=s.[CashDiscDate],[CashDiscPercent]=s.[CashDiscPercent],[CFDIUUID_MX]=s.[CFDIUUID_MX],[ConsigneeAccount_RU]=s.[ConsigneeAccount_RU],[ConsignorAccount_RU]=s.[ConsignorAccount_RU],[ConsTarget_JP]=s.[ConsTarget_JP],[ContractNum_SA]=s.[ContractNum_SA],[Correct_RU]=s.[Correct_RU],[CorrectedInvoiceDate_RU]=s.[CorrectedInvoiceDate_RU],[CorrectedInvoiceId_RU]=s.[CorrectedInvoiceId_RU],[CorrectionType_RU]=s.[CorrectionType_RU],[CorrectionType_RUEnumID]=s.[CorrectionType_RUEnumID],[CostLedgerVoucher]=s.[CostLedgerVoucher],[CountryRegionId]=s.[CountryRegionId],[CREATEDBY]=s.[CREATEDBY],[CREATEDDATETIME]=s.[CREATEDDATETIME],[CurrencyCode]=s.[CurrencyCode],[DataAreaId]=s.[DataAreaId],[DataLakeModified_DateTime]=s.[DataLakeModified_DateTime],[DefaultDimension]=s.[DefaultDimension],[DeliveryAddress_LT]=s.[DeliveryAddress_LT],[DeliveryDate_ES]=s.[DeliveryDate_ES],[DeliveryName]=s.[DeliveryName],[DeliveryName_LT]=s.[DeliveryName_LT],[DeliveryPostalAddress]=s.[DeliveryPostalAddress],[Description]=s.[Description],[DlvAddress_LV]=s.[DlvAddress_LV],[DlvMode]=s.[DlvMode],[DlvTerm]=s.[DlvTerm],[DocumentDate]=s.[DocumentDate],[DocumentNum]=s.[DocumentNum],[DocumentOrigin]=s.[DocumentOrigin],[DocumentOriginEnumID]=s.[DocumentOriginEnumID],[DueDate]=s.[DueDate],[EndDisc]=s.[EndDisc],[EndDiscMST]=s.[EndDiscMST],[EnterpriseNumber]=s.[EnterpriseNumber],[EUSalesList]=s.[EUSalesList],[ExchRate]=s.[ExchRate],[ExchRateSecondary]=s.[ExchRateSecondary],[FacturedFully_RU]=s.[FacturedFully_RU],[FiscalDocumentType_BR]=s.[FiscalDocumentType_BR],[FixedDueDate]=s.[FixedDueDate],[ImportedAmount]=s.[ImportedAmount],[ImportedSalesTax]=s.[ImportedSalesTax],[InclTax]=s.[InclTax],[IntentLetterId_IT]=s.[IntentLetterId_IT],[InterCompanyCompanyId]=s.[InterCompanyCompanyId],[InterCompanyLedgerVoucher]=s.[InterCompanyLedgerVoucher],[InterCompanyPosted]=s.[InterCompanyPosted],[InterCompanySalesId]=s.[InterCompanySalesId],[InternalInvoiceId]=s.[InternalInvoiceId],[IntrastatAddValue_LV]=s.[IntrastatAddValue_LV],[IntrastatDispatch]=s.[IntrastatDispatch],[IntrastatFulfillmentDate_HU]=s.[IntrastatFulfillmentDate_HU],[InventBaileeReceiptReportId_RU]=s.[InventBaileeReceiptReportId_RU],[InventProfileType_RU]=s.[InventProfileType_RU],[InventProfileType_RUEnumID]=s.[InventProfileType_RUEnumID],[InvoiceAccount]=s.[InvoiceAccount],[InvoiceAmount]=s.[InvoiceAmount],[InvoiceAmountMST]=s.[InvoiceAmountMST],[InvoiceDate]=s.[InvoiceDate],[InvoiceId]=s.[InvoiceId],[InvoiceRoundOff]=s.[InvoiceRoundOff],[InvoiceSeries_MX]=s.[InvoiceSeries_MX],[InvoiceType]=s.[InvoiceType],[InvoiceTypeEnumID]=s.[InvoiceTypeEnumID],[ItemBuyerGroupId]=s.[ItemBuyerGroupId],[LanguageId]=s.[LanguageId],[LedgerVoucher]=s.[LedgerVoucher],[Listcode]=s.[Listcode],[LogisticsElectronicAddress]=s.[LogisticsElectronicAddress],[MODIFIEDDATETIME]=s.[MODIFIEDDATETIME],[NonRealRevenue_RU]=s.[NonRealRevenue_RU],[NumberSequenceCode_LT]=s.[NumberSequenceCode_LT],[numberSequenceGroup]=s.[numberSequenceGroup],[OffsessionId_RU]=s.[OffsessionId_RU],[OperationType_MX]=s.[OperationType_MX],[OperationType_MXEnumID]=s.[OperationType_MXEnumID],[OrderAccount]=s.[OrderAccount],[ParmId]=s.[ParmId],[PARTITION]=s.[PARTITION],[PartyTaxID]=s.[PartyTaxID],[PaymDayId]=s.[PaymDayId],[Payment]=s.[Payment],[PaymentSched]=s.[PaymentSched],[PaymId]=s.[PaymId],[PlafondDate_IT]=s.[PlafondDate_IT],[PostingProfile]=s.[PostingProfile],[Prepayment]=s.[Prepayment],[Proforma]=s.[Proforma],[PSNPurchasingCardType]=s.[PSNPurchasingCardType],[PSNPurchasingCardTypeEnumID]=s.[PSNPurchasingCardTypeEnumID],[PurchAgreementHeader_PSN]=s.[PurchAgreementHeader_PSN],[PurchaseType]=s.[PurchaseType],[PurchaseTypeEnumID]=s.[PurchaseTypeEnumID],[PurchId]=s.[PurchId],[PurchReceiptDate_W]=s.[PurchReceiptDate_W],[Qty]=s.[Qty],[ReasonTableRef_BR]=s.[ReasonTableRef_BR],[ReceivedDate]=s.[ReceivedDate],[RECID]=s.[RECID],[RECVERSION]=s.[RECVERSION],[RemittanceAddress]=s.[RemittanceAddress],[ReportingCurrencyExchangeRate]=s.[ReportingCurrencyExchangeRate],[ReturnItemNum]=s.[ReturnItemNum],[ReverseChargeAmount]=s.[ReverseChargeAmount],[SalesBalance]=s.[SalesBalance],[SalesPurchOperationType_BR]=s.[SalesPurchOperationType_BR],[ServiceCodeOnDlvAddress_BR]=s.[ServiceCodeOnDlvAddress_BR],[SourceDocumentHeader]=s.[SourceDocumentHeader],[SourceDocumentLine]=s.[SourceDocumentLine],[State]=s.[State],[StateInvoicePrinted_LV]=s.[StateInvoicePrinted_LV],[StateInvoicePrinted_LVFlag]=s.[StateInvoicePrinted_LVFlag],[SumLineDisc]=s.[SumLineDisc],[SumMarkup]=s.[SumMarkup],[SumMarkupMST]=s.[SumMarkupMST],[SumTax]=s.[SumTax],[TaxGroup]=s.[TaxGroup],[TaxID]=s.[TaxID],[TaxInvoicePurchId]=s.[TaxInvoicePurchId],[TaxPrintOnInvoice]=s.[TaxPrintOnInvoice],[TaxRoundOff]=s.[TaxRoundOff],[TaxSetoffVoucher_IN]=s.[TaxSetoffVoucher_IN],[TaxSpecifyByLine]=s.[TaxSpecifyByLine],[TaxWithholdAmount_IN]=s.[TaxWithholdAmount_IN],[TransportationDocument]=s.[TransportationDocument],[Triangulation]=s.[Triangulation],[UnitedVATInvoice_LT]=s.[UnitedVATInvoice_LT],[VATAmount_IN]=s.[VATAmount_IN],[VATNum]=s.[VATNum],[VATOnPayment_RU]=s.[VATOnPayment_RU],[VendConsInvoice_JP]=s.[VendConsInvoice_JP],[VendFinalUser_BR]=s.[VendFinalUser_BR],[VendGroup]=s.[VendGroup],[VendInvoiceDeclaration_IS]=s.[VendInvoiceDeclaration_IS],[VendInvoiceGroup]=s.[VendInvoiceGroup],[VendorRequestedWorkerEmail]=s.[VendorRequestedWorkerEmail],[VendorVATDate]=s.[VendorVATDate],[VendPaymentGroup]=s.[VendPaymentGroup],[Volume]=s.[Volume],[Weight]=s.[Weight],[WhoIsAuthor_LT]=s.[WhoIsAuthor_LT],[WhoIsAuthor_LTEnumID]=s.[WhoIsAuthor_LTEnumID]
when not matched then insert(
	[AttorneyDate_RU],[AttorneyId_RU],[AttorneyIssuedName_RU],[BankLCImportLine],[CashDisc],[CashDiscCode],[CashDiscDate],[CashDiscPercent],[CFDIUUID_MX],[ConsigneeAccount_RU],[ConsignorAccount_RU],[ConsTarget_JP],[ContractNum_SA],[Correct_RU],[CorrectedInvoiceDate_RU],[CorrectedInvoiceId_RU],[CorrectionType_RU],[CorrectionType_RUEnumID],[CostLedgerVoucher],[CountryRegionId],[CREATEDBY],[CREATEDDATETIME],[CurrencyCode],[DataAreaId],[DataLakeModified_DateTime],[DefaultDimension],[DeliveryAddress_LT],[DeliveryDate_ES],[DeliveryName],[DeliveryName_LT],[DeliveryPostalAddress],[Description],[DlvAddress_LV],[DlvMode],[DlvTerm],[DocumentDate],[DocumentNum],[DocumentOrigin],[DocumentOriginEnumID],[DueDate],[EndDisc],[EndDiscMST],[EnterpriseNumber],[EUSalesList],[ExchRate],[ExchRateSecondary],[FacturedFully_RU],[FiscalDocumentType_BR],[FixedDueDate],[ImportedAmount],[ImportedSalesTax],[InclTax],[IntentLetterId_IT],[InterCompanyCompanyId],[InterCompanyLedgerVoucher],[InterCompanyPosted],[InterCompanySalesId],[InternalInvoiceId],[IntrastatAddValue_LV],[IntrastatDispatch],[IntrastatFulfillmentDate_HU],[InventBaileeReceiptReportId_RU],[InventProfileType_RU],[InventProfileType_RUEnumID],[InvoiceAccount],[InvoiceAmount],[InvoiceAmountMST],[InvoiceDate],[InvoiceId],[InvoiceRoundOff],[InvoiceSeries_MX],[InvoiceType],[InvoiceTypeEnumID],[ItemBuyerGroupId],[LanguageId],[LedgerVoucher],[Listcode],[LogisticsElectronicAddress],[MODIFIEDDATETIME],[NonRealRevenue_RU],[NumberSequenceCode_LT],[numberSequenceGroup],[OffsessionId_RU],[OperationType_MX],[OperationType_MXEnumID],[OrderAccount],[ParmId],[PARTITION],[PartyTaxID],[PaymDayId],[Payment],[PaymentSched],[PaymId],[PlafondDate_IT],[PostingProfile],[Prepayment],[Proforma],[PSNPurchasingCardType],[PSNPurchasingCardTypeEnumID],[PurchAgreementHeader_PSN],[PurchaseType],[PurchaseTypeEnumID],[PurchId],[PurchReceiptDate_W],[Qty],[ReasonTableRef_BR],[ReceivedDate],[RECID],[RECVERSION],[RemittanceAddress],[ReportingCurrencyExchangeRate],[ReturnItemNum],[ReverseChargeAmount],[SalesBalance],[SalesPurchOperationType_BR],[ServiceCodeOnDlvAddress_BR],[SourceDocumentHeader],[SourceDocumentLine],[State],[StateInvoicePrinted_LV],[StateInvoicePrinted_LVFlag],[SumLineDisc],[SumMarkup],[SumMarkupMST],[SumTax],[TaxGroup],[TaxID],[TaxInvoicePurchId],[TaxPrintOnInvoice],[TaxRoundOff],[TaxSetoffVoucher_IN],[TaxSpecifyByLine],[TaxWithholdAmount_IN],[TransportationDocument],[Triangulation],[UnitedVATInvoice_LT],[VATAmount_IN],[VATNum],[VATOnPayment_RU],[VendConsInvoice_JP],[VendFinalUser_BR],[VendGroup],[VendInvoiceDeclaration_IS],[VendInvoiceGroup],[VendorRequestedWorkerEmail],[VendorVATDate],[VendPaymentGroup],[Volume],[Weight],[WhoIsAuthor_LT],[WhoIsAuthor_LTEnumID]
)
values (
[AttorneyDate_RU],[AttorneyId_RU],[AttorneyIssuedName_RU],[BankLCImportLine],[CashDisc],[CashDiscCode],[CashDiscDate],[CashDiscPercent],[CFDIUUID_MX],[ConsigneeAccount_RU],[ConsignorAccount_RU],[ConsTarget_JP],[ContractNum_SA],[Correct_RU],[CorrectedInvoiceDate_RU],[CorrectedInvoiceId_RU],[CorrectionType_RU],[CorrectionType_RUEnumID],[CostLedgerVoucher],[CountryRegionId],[CREATEDBY],[CREATEDDATETIME],[CurrencyCode],[DataAreaId],[DataLakeModified_DateTime],[DefaultDimension],[DeliveryAddress_LT],[DeliveryDate_ES],[DeliveryName],[DeliveryName_LT],[DeliveryPostalAddress],[Description],[DlvAddress_LV],[DlvMode],[DlvTerm],[DocumentDate],[DocumentNum],[DocumentOrigin],[DocumentOriginEnumID],[DueDate],[EndDisc],[EndDiscMST],[EnterpriseNumber],[EUSalesList],[ExchRate],[ExchRateSecondary],[FacturedFully_RU],[FiscalDocumentType_BR],[FixedDueDate],[ImportedAmount],[ImportedSalesTax],[InclTax],[IntentLetterId_IT],[InterCompanyCompanyId],[InterCompanyLedgerVoucher],[InterCompanyPosted],[InterCompanySalesId],[InternalInvoiceId],[IntrastatAddValue_LV],[IntrastatDispatch],[IntrastatFulfillmentDate_HU],[InventBaileeReceiptReportId_RU],[InventProfileType_RU],[InventProfileType_RUEnumID],[InvoiceAccount],[InvoiceAmount],[InvoiceAmountMST],[InvoiceDate],[InvoiceId],[InvoiceRoundOff],[InvoiceSeries_MX],[InvoiceType],[InvoiceTypeEnumID],[ItemBuyerGroupId],[LanguageId],[LedgerVoucher],[Listcode],[LogisticsElectronicAddress],[MODIFIEDDATETIME],[NonRealRevenue_RU],[NumberSequenceCode_LT],[numberSequenceGroup],[OffsessionId_RU],[OperationType_MX],[OperationType_MXEnumID],[OrderAccount],[ParmId],[PARTITION],[PartyTaxID],[PaymDayId],[Payment],[PaymentSched],[PaymId],[PlafondDate_IT],[PostingProfile],[Prepayment],[Proforma],[PSNPurchasingCardType],[PSNPurchasingCardTypeEnumID],[PurchAgreementHeader_PSN],[PurchaseType],[PurchaseTypeEnumID],[PurchId],[PurchReceiptDate_W],[Qty],[ReasonTableRef_BR],[ReceivedDate],[RECID],[RECVERSION],[RemittanceAddress],[ReportingCurrencyExchangeRate],[ReturnItemNum],[ReverseChargeAmount],[SalesBalance],[SalesPurchOperationType_BR],[ServiceCodeOnDlvAddress_BR],[SourceDocumentHeader],[SourceDocumentLine],[State],[StateInvoicePrinted_LV],[StateInvoicePrinted_LVFlag],[SumLineDisc],[SumMarkup],[SumMarkupMST],[SumTax],[TaxGroup],[TaxID],[TaxInvoicePurchId],[TaxPrintOnInvoice],[TaxRoundOff],[TaxSetoffVoucher_IN],[TaxSpecifyByLine],[TaxWithholdAmount_IN],[TransportationDocument],[Triangulation],[UnitedVATInvoice_LT],[VATAmount_IN],[VATNum],[VATOnPayment_RU],[VendConsInvoice_JP],[VendFinalUser_BR],[VendGroup],[VendInvoiceDeclaration_IS],[VendInvoiceGroup],[VendorRequestedWorkerEmail],[VendorVATDate],[VendPaymentGroup],[Volume],[Weight],[WhoIsAuthor_LT],[WhoIsAuthor_LTEnumID]
);

end
GO
