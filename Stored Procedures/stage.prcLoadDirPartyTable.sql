create   proc [stage].[prcLoadDirPartyTable] as 
begin 
--This proc is automatically created by [etl].[prcMaterializeExternalData]

DELETE t from dbo.DirPartyTable t 
where exists 
	(select 1 from stage.DirPartyTable s 
	 where s.recid=t.recid 
		and (s.DML_Action='DELETE')
		and isnull(t.LSN,'')<isnull(s.Start_LSN,'')--delete the older record
	)

MERGE dbo.DirPartyTable with(tablock) as t
using (select * from blobTransInc.DirPartyTable where DML_Action<>'DELETE' and Instance=1) as s
on (s.recid=t.recid)
when matched then update set 
	[ABC]=s.[ABC],[ACCOUNTANT_LT]=s.[ACCOUNTANT_LT],[ACCOUNTINGPERSONNEL_JP]=s.[ACCOUNTINGPERSONNEL_JP],[ACCOUNTOFFICEREFNUM]=s.[ACCOUNTOFFICEREFNUM],[ACTIVITYCODE]=s.[ACTIVITYCODE],[AddressBookNames]=s.[AddressBookNames],[ADDRFORMAT]=s.[ADDRFORMAT],[ANNIVERSARYDAY]=s.[ANNIVERSARYDAY],[ANNIVERSARYMONTH]=s.[ANNIVERSARYMONTH],[ANNIVERSARYYEAR]=s.[ANNIVERSARYYEAR],[BANK]=s.[BANK],[BANKACCTUSEDFOR1099]=s.[BANKACCTUSEDFOR1099],[BANKCENTRALBANKPURPOSECODE]=s.[BANKCENTRALBANKPURPOSECODE],[BANKCENTRALBANKPURPOSETEXT]=s.[BANKCENTRALBANKPURPOSETEXT],[BIRTHDAY]=s.[BIRTHDAY],[BIRTHMONTH]=s.[BIRTHMONTH],[BIRTHYEAR]=s.[BIRTHYEAR],[BRANCHID]=s.[BRANCHID],[BUSINESSACTIVITY_SA]=s.[BUSINESSACTIVITY_SA],[BUSINESSACTIVITYDESC_SA]=s.[BUSINESSACTIVITYDESC_SA],[BUSINESSCOMMENCEDDATE_JP]=s.[BUSINESSCOMMENCEDDATE_JP],[BUSINESSINITIALCAPITAL_JP]=s.[BUSINESSINITIALCAPITAL_JP],[BUSINESSITEM_JP]=s.[BUSINESSITEM_JP],[BUSINESSNUMBER_CA]=s.[BUSINESSNUMBER_CA],[CERTIFIEDTAXACCOUNTANT_JP]=s.[CERTIFIEDTAXACCOUNTANT_JP],[CHILDRENNAMES]=s.[CHILDRENNAMES],[CNAE_BR]=s.[CNAE_BR],[COMBINEDFEDSTATEFILER]=s.[COMBINEDFEDSTATEFILER],[COMMUNICATORSIGNIN]=s.[COMMUNICATORSIGNIN],[COMPANYINITIALCAPITAL_FR]=s.[COMPANYINITIALCAPITAL_FR],[COMPANYNAFCODE]=s.[COMPANYNAFCODE],[COMPANYREGCOMFR]=s.[COMPANYREGCOMFR],[COMPANYREPRESENTATIVE_JP]=s.[COMPANYREPRESENTATIVE_JP],[COMPANYTYPE_MX]=s.[COMPANYTYPE_MX],[CONVERSIONDATE]=s.[CONVERSIONDATE],[COREGNUM]=s.[COREGNUM],[CREATEDBY]=s.[CREATEDBY],[CREATEDDATETIME]=s.[CREATEDDATETIME],[CUC_IT]=s.[CUC_IT],[CURP_MX]=s.[CURP_MX],[DASHBOARDIMAGETYPE]=s.[DASHBOARDIMAGETYPE],[DATAAREA]=s.[DATAAREA],[DataLakeModified_DateTime]=s.[DataLakeModified_DateTime],[DBA]=s.[DBA],[DECLARANTNAME_AE]=s.[DECLARANTNAME_AE],[DESCRIPTION]=s.[DESCRIPTION],[DUNSNUMBERRECID]=s.[DUNSNUMBERRECID],[DVRID]=s.[DVRID],[EEENABLEPERSONALDATAREADLOG]=s.[EEENABLEPERSONALDATAREADLOG],[EEENABLEROLECHANGELOG]=s.[EEENABLEROLECHANGELOG],[FICREDITORID_DK]=s.[FICREDITORID_DK],[FILENUMBER_SA]=s.[FILENUMBER_SA],[FISCALCODE_IT]=s.[FISCALCODE_IT],[FOREIGNENTITYINDICATOR]=s.[FOREIGNENTITYINDICATOR],[FSS_RU]=s.[FSS_RU],[FSSACCOUNT_RU]=s.[FSSACCOUNT_RU],[GENDER]=s.[GENDER],[GIRO]=s.[GIRO],[GIROCONTRACT]=s.[GIROCONTRACT],[GIROCONTRACTACCOUNT]=s.[GIROCONTRACTACCOUNT],[HCMWORKER]=s.[HCMWORKER],[HEAD_LT]=s.[HEAD_LT],[HOBBIES]=s.[HOBBIES],[IMPORTVATNUM]=s.[IMPORTVATNUM],[IMPORTVATNUMBRANCHID]=s.[IMPORTVATNUMBRANCHID],[INITIALS]=s.[INITIALS],[InstanceRelationType]=s.[InstanceRelationType],[INTRASTATCODE]=s.[INTRASTATCODE],[ISACTIVE]=s.[ISACTIVE],[ISCONSOLIDATIONCOMPANY]=s.[ISCONSOLIDATIONCOMPANY],[ISELIMINATIONCOMPANY]=s.[ISELIMINATIONCOMPANY],[ISSUINGSIGNATURE]=s.[ISSUINGSIGNATURE],[KEY_]=s.[KEY_],[KnownAs]=s.[KnownAs],[LanguageId]=s.[LanguageId],[LASTFILINGINDICATOR]=s.[LASTFILINGINDICATOR],[LegacyInstanceRelationType]=s.[LegacyInstanceRelationType],[LEGALFORMFR]=s.[LEGALFORMFR],[LEGALNATURE_IT]=s.[LEGALNATURE_IT],[LEGALREPRESENTATIVE_JP]=s.[LEGALREPRESENTATIVE_JP],[LEGALREPRESENTATIVECURP_MX]=s.[LEGALREPRESENTATIVECURP_MX],[LEGALREPRESENTATIVENAME_MX]=s.[LEGALREPRESENTATIVENAME_MX],[LEGALREPRESENTATIVERFC_MX]=s.[LEGALREPRESENTATIVERFC_MX],[LOCALIZATIONCOUNTRYREGIONCODE]=s.[LOCALIZATIONCOUNTRYREGIONCODE],[MARITALSTATUS]=s.[MARITALSTATUS],[MODIFIEDBY]=s.[MODIFIEDBY],[MODIFIEDDATETIME]=s.[MODIFIEDDATETIME],[NAICS]=s.[NAICS],[Name]=s.[Name],[NameAlias]=s.[NameAlias],[NAMECONTROL]=s.[NAMECONTROL],[NAMESEQUENCE]=s.[NAMESEQUENCE],[NUMBEROFEMPLOYEES]=s.[NUMBEROFEMPLOYEES],[OH_ConsWBSActivityNotificationScheduleType]=s.[OH_ConsWBSActivityNotificationScheduleType],[OH_ConsWBSActivityNotificationScheduleTypeEnumID]=s.[OH_ConsWBSActivityNotificationScheduleTypeEnumID],[OH_CustomerServiceEmailsEnabled]=s.[OH_CustomerServiceEmailsEnabled],[OH_LandDevEmailsEnabled]=s.[OH_LandDevEmailsEnabled],[OH_ProcurementEmailsEnabled]=s.[OH_ProcurementEmailsEnabled],[OMOPERATINGUNITNUMBER]=s.[OMOPERATINGUNITNUMBER],[OMOPERATINGUNITTYPE]=s.[OMOPERATINGUNITTYPE],[ORGANIZATIONLEGALFORM_RU]=s.[ORGANIZATIONLEGALFORM_RU],[ORGANIZATIONTYPE]=s.[ORGANIZATIONTYPE],[ORGID]=s.[ORGID],[ORGNUMBER]=s.[ORGNUMBER],[PACKMATERIALFEELICENSENUM]=s.[PACKMATERIALFEELICENSENUM],[PARTITION]=s.[PARTITION],[PartyNumber]=s.[PartyNumber],[PAYMINSTRUCTION1]=s.[PAYMINSTRUCTION1],[PAYMINSTRUCTION2]=s.[PAYMINSTRUCTION2],[PAYMINSTRUCTION3]=s.[PAYMINSTRUCTION3],[PAYMINSTRUCTION4]=s.[PAYMINSTRUCTION4],[PAYMROUTINGDNB]=s.[PAYMROUTINGDNB],[PAYMTRADERNUMBER]=s.[PAYMTRADERNUMBER],[PERSONALSUFFIX]=s.[PERSONALSUFFIX],[PERSONALTITLE]=s.[PERSONALTITLE],[PERSONINCHARGE_JP]=s.[PERSONINCHARGE_JP],[PFREGNUM_RU]=s.[PFREGNUM_RU],[PHONETICFIRSTNAME]=s.[PHONETICFIRSTNAME],[PHONETICLASTNAME]=s.[PHONETICLASTNAME],[PHONETICMIDDLENAME]=s.[PHONETICMIDDLENAME],[PHONETICNAME]=s.[PHONETICNAME],[PLANNINGCOMPANY]=s.[PLANNINGCOMPANY],[PrimaryAddressLocation]=s.[PrimaryAddressLocation],[PrimaryContactEmail]=s.[PrimaryContactEmail],[PrimaryContactFacebook]=s.[PrimaryContactFacebook],[PrimaryContactFax]=s.[PrimaryContactFax],[PrimaryContactLinkedIn]=s.[PrimaryContactLinkedIn],[PrimaryContactPhone]=s.[PrimaryContactPhone],[PrimaryContactTelex]=s.[PrimaryContactTelex],[PrimaryContactTwitter]=s.[PrimaryContactTwitter],[PrimaryContactURL]=s.[PrimaryContactURL],[PRINTCORRINVOICELABEL_DE]=s.[PRINTCORRINVOICELABEL_DE],[PRINTCORRINVOICELABELEFFDATE_DE]=s.[PRINTCORRINVOICELABELEFFDATE_DE],[PRINTENTERPRISEREGISTER_NO]=s.[PRINTENTERPRISEREGISTER_NO],[PRINTINNKPPINADDRESS_RU]=s.[PRINTINNKPPINADDRESS_RU],[PROFESSIONALSUFFIX]=s.[PROFESSIONALSUFFIX],[PROFESSIONALTITLE]=s.[PROFESSIONALTITLE],[PROFITMARGINSCHEME_AE]=s.[PROFITMARGINSCHEME_AE],[RALIENCORPCOUNTRY]=s.[RALIENCORPCOUNTRY],[RALIENCORPNAME]=s.[RALIENCORPNAME],[RECID]=s.[RECID],[RECVERSION]=s.[RECVERSION],[REGNUM]=s.[REGNUM],[RELATIONTYPE]=s.[RELATIONTYPE],[RESIDENT_W]=s.[RESIDENT_W],[RFC_MX]=s.[RFC_MX],[RFULLNAME]=s.[RFULLNAME],[SHIPPINGCALENDARID]=s.[SHIPPINGCALENDARID],[SIACODE]=s.[SIACODE],[SOFTWAREIDENTIFICATIONCODE_CA]=s.[SOFTWAREIDENTIFICATIONCODE_CA],[STATEINSCRIPTION_MX]=s.[STATEINSCRIPTION_MX],[SUBORDINATECODE]=s.[SUBORDINATECODE],[TAX1099REGNUM]=s.[TAX1099REGNUM],[TAXABLEAGENCYNAME_AE]=s.[TAXABLEAGENCYNAME_AE],[TAXABLEAGENTNAME_AE]=s.[TAXABLEAGENTNAME_AE],[TAXABLEPERSONNAME_AE]=s.[TAXABLEPERSONNAME_AE],[TAXAUTHORITY_RU]=s.[TAXAUTHORITY_RU],[TAXGSTHSTACCOUNTID_CA]=s.[TAXGSTHSTACCOUNTID_CA],[TAXREGIMECODE_MX]=s.[TAXREGIMECODE_MX],[TAXREPRESENTATIVE]=s.[TAXREPRESENTATIVE],[TCC]=s.[TCC],[TEAMADMINISTRATOR]=s.[TEAMADMINISTRATOR],[TEAMMEMBERSHIPCRITERION]=s.[TEAMMEMBERSHIPCRITERION],[TEMPLATEFOLDER_W]=s.[TEMPLATEFOLDER_W],[UPSNUM]=s.[UPSNUM],[VALIDATE1099ONENTRY]=s.[VALIDATE1099ONENTRY],[VATNUM]=s.[VATNUM],[VATNUMBRANCHID]=s.[VATNUMBRANCHID],[VATONCUSTOMERBEHALF_AE]=s.[VATONCUSTOMERBEHALF_AE],[VATREFUND_AE]=s.[VATREFUND_AE]
when not matched then insert(
	[ABC],[ACCOUNTANT_LT],[ACCOUNTINGPERSONNEL_JP],[ACCOUNTOFFICEREFNUM],[ACTIVITYCODE],[AddressBookNames],[ADDRFORMAT],[ANNIVERSARYDAY],[ANNIVERSARYMONTH],[ANNIVERSARYYEAR],[BANK],[BANKACCTUSEDFOR1099],[BANKCENTRALBANKPURPOSECODE],[BANKCENTRALBANKPURPOSETEXT],[BIRTHDAY],[BIRTHMONTH],[BIRTHYEAR],[BRANCHID],[BUSINESSACTIVITY_SA],[BUSINESSACTIVITYDESC_SA],[BUSINESSCOMMENCEDDATE_JP],[BUSINESSINITIALCAPITAL_JP],[BUSINESSITEM_JP],[BUSINESSNUMBER_CA],[CERTIFIEDTAXACCOUNTANT_JP],[CHILDRENNAMES],[CNAE_BR],[COMBINEDFEDSTATEFILER],[COMMUNICATORSIGNIN],[COMPANYINITIALCAPITAL_FR],[COMPANYNAFCODE],[COMPANYREGCOMFR],[COMPANYREPRESENTATIVE_JP],[COMPANYTYPE_MX],[CONVERSIONDATE],[COREGNUM],[CREATEDBY],[CREATEDDATETIME],[CUC_IT],[CURP_MX],[DASHBOARDIMAGETYPE],[DATAAREA],[DataLakeModified_DateTime],[DBA],[DECLARANTNAME_AE],[DESCRIPTION],[DUNSNUMBERRECID],[DVRID],[EEENABLEPERSONALDATAREADLOG],[EEENABLEROLECHANGELOG],[FICREDITORID_DK],[FILENUMBER_SA],[FISCALCODE_IT],[FOREIGNENTITYINDICATOR],[FSS_RU],[FSSACCOUNT_RU],[GENDER],[GIRO],[GIROCONTRACT],[GIROCONTRACTACCOUNT],[HCMWORKER],[HEAD_LT],[HOBBIES],[IMPORTVATNUM],[IMPORTVATNUMBRANCHID],[INITIALS],[InstanceRelationType],[INTRASTATCODE],[ISACTIVE],[ISCONSOLIDATIONCOMPANY],[ISELIMINATIONCOMPANY],[ISSUINGSIGNATURE],[KEY_],[KnownAs],[LanguageId],[LASTFILINGINDICATOR],[LegacyInstanceRelationType],[LEGALFORMFR],[LEGALNATURE_IT],[LEGALREPRESENTATIVE_JP],[LEGALREPRESENTATIVECURP_MX],[LEGALREPRESENTATIVENAME_MX],[LEGALREPRESENTATIVERFC_MX],[LOCALIZATIONCOUNTRYREGIONCODE],[MARITALSTATUS],[MODIFIEDBY],[MODIFIEDDATETIME],[NAICS],[Name],[NameAlias],[NAMECONTROL],[NAMESEQUENCE],[NUMBEROFEMPLOYEES],[OH_ConsWBSActivityNotificationScheduleType],[OH_ConsWBSActivityNotificationScheduleTypeEnumID],[OH_CustomerServiceEmailsEnabled],[OH_LandDevEmailsEnabled],[OH_ProcurementEmailsEnabled],[OMOPERATINGUNITNUMBER],[OMOPERATINGUNITTYPE],[ORGANIZATIONLEGALFORM_RU],[ORGANIZATIONTYPE],[ORGID],[ORGNUMBER],[PACKMATERIALFEELICENSENUM],[PARTITION],[PartyNumber],[PAYMINSTRUCTION1],[PAYMINSTRUCTION2],[PAYMINSTRUCTION3],[PAYMINSTRUCTION4],[PAYMROUTINGDNB],[PAYMTRADERNUMBER],[PERSONALSUFFIX],[PERSONALTITLE],[PERSONINCHARGE_JP],[PFREGNUM_RU],[PHONETICFIRSTNAME],[PHONETICLASTNAME],[PHONETICMIDDLENAME],[PHONETICNAME],[PLANNINGCOMPANY],[PrimaryAddressLocation],[PrimaryContactEmail],[PrimaryContactFacebook],[PrimaryContactFax],[PrimaryContactLinkedIn],[PrimaryContactPhone],[PrimaryContactTelex],[PrimaryContactTwitter],[PrimaryContactURL],[PRINTCORRINVOICELABEL_DE],[PRINTCORRINVOICELABELEFFDATE_DE],[PRINTENTERPRISEREGISTER_NO],[PRINTINNKPPINADDRESS_RU],[PROFESSIONALSUFFIX],[PROFESSIONALTITLE],[PROFITMARGINSCHEME_AE],[RALIENCORPCOUNTRY],[RALIENCORPNAME],[RECID],[RECVERSION],[REGNUM],[RELATIONTYPE],[RESIDENT_W],[RFC_MX],[RFULLNAME],[SHIPPINGCALENDARID],[SIACODE],[SOFTWAREIDENTIFICATIONCODE_CA],[STATEINSCRIPTION_MX],[SUBORDINATECODE],[TAX1099REGNUM],[TAXABLEAGENCYNAME_AE],[TAXABLEAGENTNAME_AE],[TAXABLEPERSONNAME_AE],[TAXAUTHORITY_RU],[TAXGSTHSTACCOUNTID_CA],[TAXREGIMECODE_MX],[TAXREPRESENTATIVE],[TCC],[TEAMADMINISTRATOR],[TEAMMEMBERSHIPCRITERION],[TEMPLATEFOLDER_W],[UPSNUM],[VALIDATE1099ONENTRY],[VATNUM],[VATNUMBRANCHID],[VATONCUSTOMERBEHALF_AE],[VATREFUND_AE]
)
values (
[ABC],[ACCOUNTANT_LT],[ACCOUNTINGPERSONNEL_JP],[ACCOUNTOFFICEREFNUM],[ACTIVITYCODE],[AddressBookNames],[ADDRFORMAT],[ANNIVERSARYDAY],[ANNIVERSARYMONTH],[ANNIVERSARYYEAR],[BANK],[BANKACCTUSEDFOR1099],[BANKCENTRALBANKPURPOSECODE],[BANKCENTRALBANKPURPOSETEXT],[BIRTHDAY],[BIRTHMONTH],[BIRTHYEAR],[BRANCHID],[BUSINESSACTIVITY_SA],[BUSINESSACTIVITYDESC_SA],[BUSINESSCOMMENCEDDATE_JP],[BUSINESSINITIALCAPITAL_JP],[BUSINESSITEM_JP],[BUSINESSNUMBER_CA],[CERTIFIEDTAXACCOUNTANT_JP],[CHILDRENNAMES],[CNAE_BR],[COMBINEDFEDSTATEFILER],[COMMUNICATORSIGNIN],[COMPANYINITIALCAPITAL_FR],[COMPANYNAFCODE],[COMPANYREGCOMFR],[COMPANYREPRESENTATIVE_JP],[COMPANYTYPE_MX],[CONVERSIONDATE],[COREGNUM],[CREATEDBY],[CREATEDDATETIME],[CUC_IT],[CURP_MX],[DASHBOARDIMAGETYPE],[DATAAREA],[DataLakeModified_DateTime],[DBA],[DECLARANTNAME_AE],[DESCRIPTION],[DUNSNUMBERRECID],[DVRID],[EEENABLEPERSONALDATAREADLOG],[EEENABLEROLECHANGELOG],[FICREDITORID_DK],[FILENUMBER_SA],[FISCALCODE_IT],[FOREIGNENTITYINDICATOR],[FSS_RU],[FSSACCOUNT_RU],[GENDER],[GIRO],[GIROCONTRACT],[GIROCONTRACTACCOUNT],[HCMWORKER],[HEAD_LT],[HOBBIES],[IMPORTVATNUM],[IMPORTVATNUMBRANCHID],[INITIALS],[InstanceRelationType],[INTRASTATCODE],[ISACTIVE],[ISCONSOLIDATIONCOMPANY],[ISELIMINATIONCOMPANY],[ISSUINGSIGNATURE],[KEY_],[KnownAs],[LanguageId],[LASTFILINGINDICATOR],[LegacyInstanceRelationType],[LEGALFORMFR],[LEGALNATURE_IT],[LEGALREPRESENTATIVE_JP],[LEGALREPRESENTATIVECURP_MX],[LEGALREPRESENTATIVENAME_MX],[LEGALREPRESENTATIVERFC_MX],[LOCALIZATIONCOUNTRYREGIONCODE],[MARITALSTATUS],[MODIFIEDBY],[MODIFIEDDATETIME],[NAICS],[Name],[NameAlias],[NAMECONTROL],[NAMESEQUENCE],[NUMBEROFEMPLOYEES],[OH_ConsWBSActivityNotificationScheduleType],[OH_ConsWBSActivityNotificationScheduleTypeEnumID],[OH_CustomerServiceEmailsEnabled],[OH_LandDevEmailsEnabled],[OH_ProcurementEmailsEnabled],[OMOPERATINGUNITNUMBER],[OMOPERATINGUNITTYPE],[ORGANIZATIONLEGALFORM_RU],[ORGANIZATIONTYPE],[ORGID],[ORGNUMBER],[PACKMATERIALFEELICENSENUM],[PARTITION],[PartyNumber],[PAYMINSTRUCTION1],[PAYMINSTRUCTION2],[PAYMINSTRUCTION3],[PAYMINSTRUCTION4],[PAYMROUTINGDNB],[PAYMTRADERNUMBER],[PERSONALSUFFIX],[PERSONALTITLE],[PERSONINCHARGE_JP],[PFREGNUM_RU],[PHONETICFIRSTNAME],[PHONETICLASTNAME],[PHONETICMIDDLENAME],[PHONETICNAME],[PLANNINGCOMPANY],[PrimaryAddressLocation],[PrimaryContactEmail],[PrimaryContactFacebook],[PrimaryContactFax],[PrimaryContactLinkedIn],[PrimaryContactPhone],[PrimaryContactTelex],[PrimaryContactTwitter],[PrimaryContactURL],[PRINTCORRINVOICELABEL_DE],[PRINTCORRINVOICELABELEFFDATE_DE],[PRINTENTERPRISEREGISTER_NO],[PRINTINNKPPINADDRESS_RU],[PROFESSIONALSUFFIX],[PROFESSIONALTITLE],[PROFITMARGINSCHEME_AE],[RALIENCORPCOUNTRY],[RALIENCORPNAME],[RECID],[RECVERSION],[REGNUM],[RELATIONTYPE],[RESIDENT_W],[RFC_MX],[RFULLNAME],[SHIPPINGCALENDARID],[SIACODE],[SOFTWAREIDENTIFICATIONCODE_CA],[STATEINSCRIPTION_MX],[SUBORDINATECODE],[TAX1099REGNUM],[TAXABLEAGENCYNAME_AE],[TAXABLEAGENTNAME_AE],[TAXABLEPERSONNAME_AE],[TAXAUTHORITY_RU],[TAXGSTHSTACCOUNTID_CA],[TAXREGIMECODE_MX],[TAXREPRESENTATIVE],[TCC],[TEAMADMINISTRATOR],[TEAMMEMBERSHIPCRITERION],[TEMPLATEFOLDER_W],[UPSNUM],[VALIDATE1099ONENTRY],[VATNUM],[VATNUMBRANCHID],[VATONCUSTOMERBEHALF_AE],[VATREFUND_AE]
);

end
GO
