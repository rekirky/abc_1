create   proc [stage].[prcLoadVendTrans] as 
begin 
--This proc is automatically created by [etl].[prcMaterializeExternalData]

DELETE t from dbo.VendTrans t 
where exists 
	(select 1 from stage.VendTrans s 
	 where s.recid=t.recid 
		and (s.DML_Action='DELETE')
		and isnull(t.LSN,'')<isnull(s.Start_LSN,'')--delete the older record
	)

MERGE dbo.VendTrans with(tablock) as t
using (select * from blobTransInc.VendTrans where DML_Action<>'DELETE' and Instance=1) as s
on (s.recid=t.recid)
when matched then update set 
	[AccountingEvent]=s.[AccountingEvent],[AccountNum]=s.[AccountNum],[AmountCur]=s.[AmountCur],[AmountMST]=s.[AmountMST],[Approved]=s.[Approved],[ApprovedDate]=s.[ApprovedDate],[Approver]=s.[Approver],[Arrival]=s.[Arrival],[ArrivalAccountId]=s.[ArrivalAccountId],[BankCentralBankPurposeCode]=s.[BankCentralBankPurposeCode],[BankCentralBankPurposeText]=s.[BankCentralBankPurposeText],[BankLCImportLine]=s.[BankLCImportLine],[BankRemittanceFileId]=s.[BankRemittanceFileId],[Cancel]=s.[Cancel],[CashDiscBaseDate]=s.[CashDiscBaseDate],[CashDiscCode]=s.[CashDiscCode],[Closed]=s.[Closed],[CompanyBankAccountId]=s.[CompanyBankAccountId],[Correct]=s.[Correct],[CREATEDBY]=s.[CREATEDBY],[CREATEDDATETIME]=s.[CREATEDDATETIME],[CREATEDTRANSACTIONID]=s.[CREATEDTRANSACTIONID],[CurrencyCode]=s.[CurrencyCode],[DataAreaId]=s.[DataAreaId],[DataLakeModified_DateTime]=s.[DataLakeModified_DateTime],[DefaultDimension]=s.[DefaultDimension],[DocumentDate]=s.[DocumentDate],[DocumentNum]=s.[DocumentNum],[DueDate]=s.[DueDate],[EUROTriangulation]=s.[EUROTriangulation],[ExchAdjustment]=s.[ExchAdjustment],[ExchAdjustmentReporting]=s.[ExchAdjustmentReporting],[ExchRate]=s.[ExchRate],[ExchRateSecond]=s.[ExchRateSecond],[FixedExchRate]=s.[FixedExchRate],[Invoice]=s.[Invoice],[InvoiceProject]=s.[InvoiceProject],[InvoiceProjectFlag]=s.[InvoiceProjectFlag],[InvoiceReleaseDate]=s.[InvoiceReleaseDate],[INVOICERELEASEDATETZID]=s.[INVOICERELEASEDATETZID],[JournalNum]=s.[JournalNum],[LastExchAdj]=s.[LastExchAdj],[LastExchAdjRate]=s.[LastExchAdjRate],[LastExchAdjRateReporting]=s.[LastExchAdjRateReporting],[LastExchAdjVoucher]=s.[LastExchAdjVoucher],[LastSettleAccountNum]=s.[LastSettleAccountNum],[LastSettleCompany]=s.[LastSettleCompany],[LastSettleDate]=s.[LastSettleDate],[LastSettleVoucher]=s.[LastSettleVoucher],[MODIFIEDBY]=s.[MODIFIEDBY],[MODIFIEDDATETIME]=s.[MODIFIEDDATETIME],[MODIFIEDTRANSACTIONID]=s.[MODIFIEDTRANSACTIONID],[OffsetRecid]=s.[OffsetRecid],[OH_ConsWorkOrderId]=s.[OH_ConsWorkOrderId],[PARTITION]=s.[PARTITION],[PaymId]=s.[PaymId],[PaymMode]=s.[PaymMode],[PaymReference]=s.[PaymReference],[PaymSpec]=s.[PaymSpec],[PaymTermId]=s.[PaymTermId],[PostingProfile]=s.[PostingProfile],[PostingProfileApprove]=s.[PostingProfileApprove],[PostingProfileCancel]=s.[PostingProfileCancel],[PostingProfileClose]=s.[PostingProfileClose],[PostingProfileReOpen]=s.[PostingProfileReOpen],[Prepayment]=s.[Prepayment],[PrepaymentFlag]=s.[PrepaymentFlag],[PromissoryNoteID]=s.[PromissoryNoteID],[PromissoryNoteSeqNum]=s.[PromissoryNoteSeqNum],[PromissoryNoteStatus]=s.[PromissoryNoteStatus],[PSNJournalizingDefinition]=s.[PSNJournalizingDefinition],[PSNPurchasingCardType]=s.[PSNPurchasingCardType],[PSNPurchasingCardTypeEnumID]=s.[PSNPurchasingCardTypeEnumID],[RBOVendTrans]=s.[RBOVendTrans],[ReasonRefRecId]=s.[ReasonRefRecId],[RECID]=s.[RECID],[RECVERSION]=s.[RECVERSION],[ReleaseDateComment]=s.[ReleaseDateComment],[RemittanceAddress]=s.[RemittanceAddress],[RemittanceLocation]=s.[RemittanceLocation],[ReportingCurrencyAmount]=s.[ReportingCurrencyAmount],[ReportingCurrencyCrossRate]=s.[ReportingCurrencyCrossRate],[ReportingCurrencyExchRate]=s.[ReportingCurrencyExchRate],[ReportingCurrencyExchRateSecondary]=s.[ReportingCurrencyExchRateSecondary],[ReportingExchAdjustmentRealized]=s.[ReportingExchAdjustmentRealized],[ReportingExchAdjustmentUnrealized]=s.[ReportingExchAdjustmentUnrealized],[SettleAmountCur]=s.[SettleAmountCur],[SettleAmountMST]=s.[SettleAmountMST],[SettleAmountReporting]=s.[SettleAmountReporting],[Settlement]=s.[Settlement],[SettleTax1099Amount]=s.[SettleTax1099Amount],[SettleTax1099StateAmount]=s.[SettleTax1099StateAmount],[SummaryAccountId]=s.[SummaryAccountId],[Tax1099Amount]=s.[Tax1099Amount],[Tax1099Date]=s.[Tax1099Date],[Tax1099Fields]=s.[Tax1099Fields],[Tax1099Num]=s.[Tax1099Num],[Tax1099RecId]=s.[Tax1099RecId],[Tax1099State]=s.[Tax1099State],[Tax1099StateAmount]=s.[Tax1099StateAmount],[TaxInvoicePurchId]=s.[TaxInvoicePurchId],[ThirdPartyBankAccountId]=s.[ThirdPartyBankAccountId],[TransDate]=s.[TransDate],[TransType]=s.[TransType],[TransTypeEnumID]=s.[TransTypeEnumID],[Txt]=s.[Txt],[VendExchAdjustmentRealized]=s.[VendExchAdjustmentRealized],[VendExchAdjustmentUnrealized]=s.[VendExchAdjustmentUnrealized],[VendorVATDate]=s.[VendorVATDate],[VendPaymentGroup]=s.[VendPaymentGroup],[Voucher]=s.[Voucher]
when not matched then insert(
	[AccountingEvent],[AccountNum],[AmountCur],[AmountMST],[Approved],[ApprovedDate],[Approver],[Arrival],[ArrivalAccountId],[BankCentralBankPurposeCode],[BankCentralBankPurposeText],[BankLCImportLine],[BankRemittanceFileId],[Cancel],[CashDiscBaseDate],[CashDiscCode],[Closed],[CompanyBankAccountId],[Correct],[CREATEDBY],[CREATEDDATETIME],[CREATEDTRANSACTIONID],[CurrencyCode],[DataAreaId],[DataLakeModified_DateTime],[DefaultDimension],[DocumentDate],[DocumentNum],[DueDate],[EUROTriangulation],[ExchAdjustment],[ExchAdjustmentReporting],[ExchRate],[ExchRateSecond],[FixedExchRate],[Invoice],[InvoiceProject],[InvoiceProjectFlag],[InvoiceReleaseDate],[INVOICERELEASEDATETZID],[JournalNum],[LastExchAdj],[LastExchAdjRate],[LastExchAdjRateReporting],[LastExchAdjVoucher],[LastSettleAccountNum],[LastSettleCompany],[LastSettleDate],[LastSettleVoucher],[MODIFIEDBY],[MODIFIEDDATETIME],[MODIFIEDTRANSACTIONID],[OffsetRecid],[OH_ConsWorkOrderId],[PARTITION],[PaymId],[PaymMode],[PaymReference],[PaymSpec],[PaymTermId],[PostingProfile],[PostingProfileApprove],[PostingProfileCancel],[PostingProfileClose],[PostingProfileReOpen],[Prepayment],[PrepaymentFlag],[PromissoryNoteID],[PromissoryNoteSeqNum],[PromissoryNoteStatus],[PSNJournalizingDefinition],[PSNPurchasingCardType],[PSNPurchasingCardTypeEnumID],[RBOVendTrans],[ReasonRefRecId],[RECID],[RECVERSION],[ReleaseDateComment],[RemittanceAddress],[RemittanceLocation],[ReportingCurrencyAmount],[ReportingCurrencyCrossRate],[ReportingCurrencyExchRate],[ReportingCurrencyExchRateSecondary],[ReportingExchAdjustmentRealized],[ReportingExchAdjustmentUnrealized],[SettleAmountCur],[SettleAmountMST],[SettleAmountReporting],[Settlement],[SettleTax1099Amount],[SettleTax1099StateAmount],[SummaryAccountId],[Tax1099Amount],[Tax1099Date],[Tax1099Fields],[Tax1099Num],[Tax1099RecId],[Tax1099State],[Tax1099StateAmount],[TaxInvoicePurchId],[ThirdPartyBankAccountId],[TransDate],[TransType],[TransTypeEnumID],[Txt],[VendExchAdjustmentRealized],[VendExchAdjustmentUnrealized],[VendorVATDate],[VendPaymentGroup],[Voucher]
)
values (
[AccountingEvent],[AccountNum],[AmountCur],[AmountMST],[Approved],[ApprovedDate],[Approver],[Arrival],[ArrivalAccountId],[BankCentralBankPurposeCode],[BankCentralBankPurposeText],[BankLCImportLine],[BankRemittanceFileId],[Cancel],[CashDiscBaseDate],[CashDiscCode],[Closed],[CompanyBankAccountId],[Correct],[CREATEDBY],[CREATEDDATETIME],[CREATEDTRANSACTIONID],[CurrencyCode],[DataAreaId],[DataLakeModified_DateTime],[DefaultDimension],[DocumentDate],[DocumentNum],[DueDate],[EUROTriangulation],[ExchAdjustment],[ExchAdjustmentReporting],[ExchRate],[ExchRateSecond],[FixedExchRate],[Invoice],[InvoiceProject],[InvoiceProjectFlag],[InvoiceReleaseDate],[INVOICERELEASEDATETZID],[JournalNum],[LastExchAdj],[LastExchAdjRate],[LastExchAdjRateReporting],[LastExchAdjVoucher],[LastSettleAccountNum],[LastSettleCompany],[LastSettleDate],[LastSettleVoucher],[MODIFIEDBY],[MODIFIEDDATETIME],[MODIFIEDTRANSACTIONID],[OffsetRecid],[OH_ConsWorkOrderId],[PARTITION],[PaymId],[PaymMode],[PaymReference],[PaymSpec],[PaymTermId],[PostingProfile],[PostingProfileApprove],[PostingProfileCancel],[PostingProfileClose],[PostingProfileReOpen],[Prepayment],[PrepaymentFlag],[PromissoryNoteID],[PromissoryNoteSeqNum],[PromissoryNoteStatus],[PSNJournalizingDefinition],[PSNPurchasingCardType],[PSNPurchasingCardTypeEnumID],[RBOVendTrans],[ReasonRefRecId],[RECID],[RECVERSION],[ReleaseDateComment],[RemittanceAddress],[RemittanceLocation],[ReportingCurrencyAmount],[ReportingCurrencyCrossRate],[ReportingCurrencyExchRate],[ReportingCurrencyExchRateSecondary],[ReportingExchAdjustmentRealized],[ReportingExchAdjustmentUnrealized],[SettleAmountCur],[SettleAmountMST],[SettleAmountReporting],[Settlement],[SettleTax1099Amount],[SettleTax1099StateAmount],[SummaryAccountId],[Tax1099Amount],[Tax1099Date],[Tax1099Fields],[Tax1099Num],[Tax1099RecId],[Tax1099State],[Tax1099StateAmount],[TaxInvoicePurchId],[ThirdPartyBankAccountId],[TransDate],[TransType],[TransTypeEnumID],[Txt],[VendExchAdjustmentRealized],[VendExchAdjustmentUnrealized],[VendorVATDate],[VendPaymentGroup],[Voucher]
);

end
GO
