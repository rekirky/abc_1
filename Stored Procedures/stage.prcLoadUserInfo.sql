create   proc [stage].[prcLoadUserInfo] as 
begin 
--This proc is automatically created by [etl].[prcMaterializeExternalData]

DELETE t from dbo.UserInfo t 
where exists 
	(select 1 from stage.UserInfo s 
	 where s.recid=t.recid 
		and (s.DML_Action='DELETE')
		and isnull(t.LSN,'')<isnull(s.Start_LSN,'')--delete the older record
	)

MERGE dbo.UserInfo with(tablock) as t
using (select * from blobTransInc.UserInfo where DML_Action<>'DELETE' and Instance=1) as s
on (s.recid=t.recid)
when matched then update set 
	[ACCOUNTTYPE]=s.[ACCOUNTTYPE],[AUTOINFO]=s.[AUTOINFO],[AUTOLOGOFF]=s.[AUTOLOGOFF],[AUTOUPDATE]=s.[AUTOUPDATE],[CLIENTACCESSLOGLEVEL]=s.[CLIENTACCESSLOGLEVEL],[COMPANY]=s.[COMPANY],[COMPILERWARNINGLEVEL]=s.[COMPILERWARNINGLEVEL],[CONFIRMDELETE]=s.[CONFIRMDELETE],[CONFIRMUPDATE]=s.[CONFIRMUPDATE],[CREDENTIALRECID]=s.[CREDENTIALRECID],[DataLakeModified_DateTime]=s.[DataLakeModified_DateTime],[DEBUGGERPOPUP]=s.[DEBUGGERPOPUP],[DEBUGINFO]=s.[DEBUGINFO],[DEFAULTPARTITION]=s.[DEFAULTPARTITION],[DEL_DEFAULTMODELID]=s.[DEL_DEFAULTMODELID],[DEL_OSACCOUNTNAME]=s.[DEL_OSACCOUNTNAME],[DEL_PASSWORD]=s.[DEL_PASSWORD],[DEL_STARTUPMENU]=s.[DEL_STARTUPMENU],[ENABLE]=s.[ENABLE],[ENABLEDONCE]=s.[ENABLEDONCE],[EXTERNALID]=s.[EXTERNALID],[EXTERNALIDTYPE]=s.[EXTERNALIDTYPE],[EXTERNALUSER]=s.[EXTERNALUSER],[FILTERBYGRIDONBYDEFAULT]=s.[FILTERBYGRIDONBYDEFAULT],[FORMFONTNAME]=s.[FORMFONTNAME],[FORMFONTSIZE]=s.[FORMFONTSIZE],[GARBAGECOLLECTLIMIT]=s.[GARBAGECOLLECTLIMIT],[GENERALINFO]=s.[GENERALINFO],[GLOBALEXCELEXPORTFILEPATH]=s.[GLOBALEXCELEXPORTFILEPATH],[GLOBALEXCELEXPORTMODE]=s.[GLOBALEXCELEXPORTMODE],[GLOBALFORMOPENMODE]=s.[GLOBALFORMOPENMODE],[GLOBALLISTPAGELINKMODE]=s.[GLOBALLISTPAGELINKMODE],[HELPLANGUAGE]=s.[HELPLANGUAGE],[HISTORYLIMIT]=s.[HISTORYLIMIT],[HOMEPAGEREFRESHDURATION]=s.[HOMEPAGEREFRESHDURATION],[ID]=s.[ID],[IDENTITYPROVIDER]=s.[IDENTITYPROVIDER],[INFOLOGLEVEL]=s.[INFOLOGLEVEL],[INTERACTIVELOGON]=s.[INTERACTIVELOGON],[ISMICROSOFTACCOUNT]=s.[ISMICROSOFTACCOUNT],[ISSUERRECID]=s.[ISSUERRECID],[LANGUAGE]=s.[LANGUAGE],[MESSAGELIMIT]=s.[MESSAGELIMIT],[NAME]=s.[NAME],[NETWORKALIAS]=s.[NETWORKALIAS],[NETWORKDOMAIN]=s.[NETWORKDOMAIN],[NOTIFYTIMEZONEMISMATCH]=s.[NOTIFYTIMEZONEMISMATCH],[OBJECTID]=s.[OBJECTID],[PARTITION]=s.[PARTITION],[PREFERREDCALENDAR]=s.[PREFERREDCALENDAR],[PREFERREDLOCALE]=s.[PREFERREDLOCALE],[PREFERREDTIMEZONE]=s.[PREFERREDTIMEZONE],[PROPERTYFONTNAME]=s.[PROPERTYFONTNAME],[PROPERTYFONTSIZE]=s.[PROPERTYFONTSIZE],[QUERYTIMELIMIT]=s.[QUERYTIMELIMIT],[RECID]=s.[RECID],[RECVERSION]=s.[RECVERSION],[REPORTBOTTOMMARGIN]=s.[REPORTBOTTOMMARGIN],[REPORTFONTNAME]=s.[REPORTFONTNAME],[REPORTFONTSIZE]=s.[REPORTFONTSIZE],[REPORTLEFTMARGIN]=s.[REPORTLEFTMARGIN],[REPORTRIGHTMARGIN]=s.[REPORTRIGHTMARGIN],[REPORTTOPMARGIN]=s.[REPORTTOPMARGIN],[SHOWAOTLAYER]=s.[SHOWAOTLAYER],[SHOWMODELNAMEINAOT]=s.[SHOWMODELNAMEINAOT],[SHOWSTATUSLINE]=s.[SHOWSTATUSLINE],[SHOWTOOLBAR]=s.[SHOWTOOLBAR],[SID]=s.[SID],[STARTUPPROJECT]=s.[STARTUPPROJECT],[STATUSLINEINFO]=s.[STATUSLINEINFO],[TOOLBARINFO]=s.[TOOLBARINFO],[TRACEINFO]=s.[TRACEINFO]
when not matched then insert(
	[ACCOUNTTYPE],[AUTOINFO],[AUTOLOGOFF],[AUTOUPDATE],[CLIENTACCESSLOGLEVEL],[COMPANY],[COMPILERWARNINGLEVEL],[CONFIRMDELETE],[CONFIRMUPDATE],[CREDENTIALRECID],[DataLakeModified_DateTime],[DEBUGGERPOPUP],[DEBUGINFO],[DEFAULTPARTITION],[DEL_DEFAULTMODELID],[DEL_OSACCOUNTNAME],[DEL_PASSWORD],[DEL_STARTUPMENU],[ENABLE],[ENABLEDONCE],[EXTERNALID],[EXTERNALIDTYPE],[EXTERNALUSER],[FILTERBYGRIDONBYDEFAULT],[FORMFONTNAME],[FORMFONTSIZE],[GARBAGECOLLECTLIMIT],[GENERALINFO],[GLOBALEXCELEXPORTFILEPATH],[GLOBALEXCELEXPORTMODE],[GLOBALFORMOPENMODE],[GLOBALLISTPAGELINKMODE],[HELPLANGUAGE],[HISTORYLIMIT],[HOMEPAGEREFRESHDURATION],[ID],[IDENTITYPROVIDER],[INFOLOGLEVEL],[INTERACTIVELOGON],[ISMICROSOFTACCOUNT],[ISSUERRECID],[LANGUAGE],[MESSAGELIMIT],[NAME],[NETWORKALIAS],[NETWORKDOMAIN],[NOTIFYTIMEZONEMISMATCH],[OBJECTID],[PARTITION],[PREFERREDCALENDAR],[PREFERREDLOCALE],[PREFERREDTIMEZONE],[PROPERTYFONTNAME],[PROPERTYFONTSIZE],[QUERYTIMELIMIT],[RECID],[RECVERSION],[REPORTBOTTOMMARGIN],[REPORTFONTNAME],[REPORTFONTSIZE],[REPORTLEFTMARGIN],[REPORTRIGHTMARGIN],[REPORTTOPMARGIN],[SHOWAOTLAYER],[SHOWMODELNAMEINAOT],[SHOWSTATUSLINE],[SHOWTOOLBAR],[SID],[STARTUPPROJECT],[STATUSLINEINFO],[TOOLBARINFO],[TRACEINFO]
)
values (
[ACCOUNTTYPE],[AUTOINFO],[AUTOLOGOFF],[AUTOUPDATE],[CLIENTACCESSLOGLEVEL],[COMPANY],[COMPILERWARNINGLEVEL],[CONFIRMDELETE],[CONFIRMUPDATE],[CREDENTIALRECID],[DataLakeModified_DateTime],[DEBUGGERPOPUP],[DEBUGINFO],[DEFAULTPARTITION],[DEL_DEFAULTMODELID],[DEL_OSACCOUNTNAME],[DEL_PASSWORD],[DEL_STARTUPMENU],[ENABLE],[ENABLEDONCE],[EXTERNALID],[EXTERNALIDTYPE],[EXTERNALUSER],[FILTERBYGRIDONBYDEFAULT],[FORMFONTNAME],[FORMFONTSIZE],[GARBAGECOLLECTLIMIT],[GENERALINFO],[GLOBALEXCELEXPORTFILEPATH],[GLOBALEXCELEXPORTMODE],[GLOBALFORMOPENMODE],[GLOBALLISTPAGELINKMODE],[HELPLANGUAGE],[HISTORYLIMIT],[HOMEPAGEREFRESHDURATION],[ID],[IDENTITYPROVIDER],[INFOLOGLEVEL],[INTERACTIVELOGON],[ISMICROSOFTACCOUNT],[ISSUERRECID],[LANGUAGE],[MESSAGELIMIT],[NAME],[NETWORKALIAS],[NETWORKDOMAIN],[NOTIFYTIMEZONEMISMATCH],[OBJECTID],[PARTITION],[PREFERREDCALENDAR],[PREFERREDLOCALE],[PREFERREDTIMEZONE],[PROPERTYFONTNAME],[PROPERTYFONTSIZE],[QUERYTIMELIMIT],[RECID],[RECVERSION],[REPORTBOTTOMMARGIN],[REPORTFONTNAME],[REPORTFONTSIZE],[REPORTLEFTMARGIN],[REPORTRIGHTMARGIN],[REPORTTOPMARGIN],[SHOWAOTLAYER],[SHOWMODELNAMEINAOT],[SHOWSTATUSLINE],[SHOWTOOLBAR],[SID],[STARTUPPROJECT],[STATUSLINEINFO],[TOOLBARINFO],[TRACEINFO]
);

end
GO
