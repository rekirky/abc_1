create   proc [stage].[prcLoadCustTrans] as 
begin 
--This proc is automatically created by [etl].[prcMaterializeExternalData]

DELETE t from dbo.CustTrans t 
where exists 
	(select 1 from stage.CustTrans s 
	 where s.recid=t.recid 
		and (s.DML_Action='DELETE')
		and isnull(t.LSN,'')<isnull(s.Start_LSN,'')--delete the older record
	)

MERGE dbo.CustTrans with(tablock) as t
using (select * from blobTransInc.CustTrans where DML_Action<>'DELETE' and Instance=1) as s
on (s.recid=t.recid)
when matched then update set 
	[AccountingEvent]=s.[AccountingEvent],[AccountNum]=s.[AccountNum],[AmountCur]=s.[AmountCur],[AmountMST]=s.[AmountMST],[Approved]=s.[Approved],[Approver]=s.[Approver],[BankCentralBankPurposeCode]=s.[BankCentralBankPurposeCode],[BankCentralBankPurposeText]=s.[BankCentralBankPurposeText],[BankLCExportLine]=s.[BankLCExportLine],[BankRemittanceFileId]=s.[BankRemittanceFileId],[BillOfExchangeID]=s.[BillOfExchangeID],[BillOfExchangeSeqNum]=s.[BillOfExchangeSeqNum],[BillOfExchangeStatus]=s.[BillOfExchangeStatus],[CancelledPayment]=s.[CancelledPayment],[CashDiscBaseDate]=s.[CashDiscBaseDate],[CashDiscCode]=s.[CashDiscCode],[CashPayment]=s.[CashPayment],[CashPaymentFlag]=s.[CashPaymentFlag],[Closed]=s.[Closed],[CollectionLetter]=s.[CollectionLetter],[CollectionLetterFlag]=s.[CollectionLetterFlag],[CollectionLetterCode]=s.[CollectionLetterCode],[CollectionLetterCodeEnumID]=s.[CollectionLetterCodeEnumID],[CompanyBankAccountId]=s.[CompanyBankAccountId],[ControlNum]=s.[ControlNum],[Correct]=s.[Correct],[CREATEDBY]=s.[CREATEDBY],[CREATEDDATETIME]=s.[CREATEDDATETIME],[CREATEDTRANSACTIONID]=s.[CREATEDTRANSACTIONID],[CredManExcludeFromCreditControl]=s.[CredManExcludeFromCreditControl],[CurrencyCode]=s.[CurrencyCode],[CustAutomationExclude]=s.[CustAutomationExclude],[CustAutomationExcludeFlag]=s.[CustAutomationExcludeFlag],[CustAutomationPredictionSent]=s.[CustAutomationPredictionSent],[CustAutomationPredictionSentFlag]=s.[CustAutomationPredictionSentFlag],[CustAutomationPredunningSent]=s.[CustAutomationPredunningSent],[CustAutomationPredunningSentFlag]=s.[CustAutomationPredunningSentFlag],[CustBillingClassification]=s.[CustBillingClassification],[CustExchAdjustmentRealized]=s.[CustExchAdjustmentRealized],[CustExchAdjustmentUnrealized]=s.[CustExchAdjustmentUnrealized],[DataAreaId]=s.[DataAreaId],[DataLakeModified_DateTime]=s.[DataLakeModified_DateTime],[DefaultDimension]=s.[DefaultDimension],[DeliveryMode]=s.[DeliveryMode],[DirectDebitMandate]=s.[DirectDebitMandate],[DocumentDate]=s.[DocumentDate],[DocumentNum]=s.[DocumentNum],[DueDate]=s.[DueDate],[EUROTriangulation]=s.[EUROTriangulation],[ExchAdjustment]=s.[ExchAdjustment],[ExchAdjustmentReporting]=s.[ExchAdjustmentReporting],[ExchRate]=s.[ExchRate],[ExchRateSecond]=s.[ExchRateSecond],[FixedExchRate]=s.[FixedExchRate],[Interest]=s.[Interest],[Invoice]=s.[Invoice],[INVOICEPROJECT]=s.[INVOICEPROJECT],[InvoiceType_IT]=s.[InvoiceType_IT],[InvoiceType_ITEnumID]=s.[InvoiceType_ITEnumID],[LastExchAdj]=s.[LastExchAdj],[LastExchAdjRate]=s.[LastExchAdjRate],[LastExchAdjRateReporting]=s.[LastExchAdjRateReporting],[LastExchAdjVoucher]=s.[LastExchAdjVoucher],[LastSettleAccountNum]=s.[LastSettleAccountNum],[LastSettleCompany]=s.[LastSettleCompany],[LastSettleDate]=s.[LastSettleDate],[LastSettleVoucher]=s.[LastSettleVoucher],[MCRPaymOrderID]=s.[MCRPaymOrderID],[MODIFIEDBY]=s.[MODIFIEDBY],[MODIFIEDDATETIME]=s.[MODIFIEDDATETIME],[MODIFIEDTRANSACTIONID]=s.[MODIFIEDTRANSACTIONID],[OffsetRecid]=s.[OffsetRecid],[OrderAccount]=s.[OrderAccount],[PARTITION]=s.[PARTITION],[PaymId]=s.[PaymId],[PaymMethod]=s.[PaymMethod],[PaymMethodEnumID]=s.[PaymMethodEnumID],[PaymMode]=s.[PaymMode],[PaymReference]=s.[PaymReference],[PaymSchedId]=s.[PaymSchedId],[PaymSpec]=s.[PaymSpec],[PaymTermId]=s.[PaymTermId],[PostingProfile]=s.[PostingProfile],[PostingProfileClose]=s.[PostingProfileClose],[Prepayment]=s.[Prepayment],[PrepaymentFlag]=s.[PrepaymentFlag],[ReasonRefRecId]=s.[ReasonRefRecId],[RECID]=s.[RECID],[RECVERSION]=s.[RECVERSION],[ReportingCurrencyAmount]=s.[ReportingCurrencyAmount],[ReportingCurrencyCrossRate]=s.[ReportingCurrencyCrossRate],[ReportingCurrencyExchRate]=s.[ReportingCurrencyExchRate],[ReportingCurrencyExchRateSecondary]=s.[ReportingCurrencyExchRateSecondary],[ReportingExchAdjustmentRealized]=s.[ReportingExchAdjustmentRealized],[ReportingExchAdjustmentUnrealized]=s.[ReportingExchAdjustmentUnrealized],[RetailCustTrans]=s.[RetailCustTrans],[RetailStoreId]=s.[RetailStoreId],[RetailTerminalId]=s.[RetailTerminalId],[RetailTransactionId]=s.[RetailTransactionId],[SettleAmount_MX]=s.[SettleAmount_MX],[SettleAmountCur]=s.[SettleAmountCur],[SettleAmountMST]=s.[SettleAmountMST],[SettleAmountReporting]=s.[SettleAmountReporting],[Settlement]=s.[Settlement],[TaxInvoiceSalesId]=s.[TaxInvoiceSalesId],[ThirdPartyBankAccountId]=s.[ThirdPartyBankAccountId],[TransDate]=s.[TransDate],[TransType]=s.[TransType],[TransTypeEnumID]=s.[TransTypeEnumID],[Txt]=s.[Txt],[Voucher]=s.[Voucher]
when not matched then insert(
	[AccountingEvent],[AccountNum],[AmountCur],[AmountMST],[Approved],[Approver],[BankCentralBankPurposeCode],[BankCentralBankPurposeText],[BankLCExportLine],[BankRemittanceFileId],[BillOfExchangeID],[BillOfExchangeSeqNum],[BillOfExchangeStatus],[CancelledPayment],[CashDiscBaseDate],[CashDiscCode],[CashPayment],[CashPaymentFlag],[Closed],[CollectionLetter],[CollectionLetterFlag],[CollectionLetterCode],[CollectionLetterCodeEnumID],[CompanyBankAccountId],[ControlNum],[Correct],[CREATEDBY],[CREATEDDATETIME],[CREATEDTRANSACTIONID],[CredManExcludeFromCreditControl],[CurrencyCode],[CustAutomationExclude],[CustAutomationExcludeFlag],[CustAutomationPredictionSent],[CustAutomationPredictionSentFlag],[CustAutomationPredunningSent],[CustAutomationPredunningSentFlag],[CustBillingClassification],[CustExchAdjustmentRealized],[CustExchAdjustmentUnrealized],[DataAreaId],[DataLakeModified_DateTime],[DefaultDimension],[DeliveryMode],[DirectDebitMandate],[DocumentDate],[DocumentNum],[DueDate],[EUROTriangulation],[ExchAdjustment],[ExchAdjustmentReporting],[ExchRate],[ExchRateSecond],[FixedExchRate],[Interest],[Invoice],[INVOICEPROJECT],[InvoiceType_IT],[InvoiceType_ITEnumID],[LastExchAdj],[LastExchAdjRate],[LastExchAdjRateReporting],[LastExchAdjVoucher],[LastSettleAccountNum],[LastSettleCompany],[LastSettleDate],[LastSettleVoucher],[MCRPaymOrderID],[MODIFIEDBY],[MODIFIEDDATETIME],[MODIFIEDTRANSACTIONID],[OffsetRecid],[OrderAccount],[PARTITION],[PaymId],[PaymMethod],[PaymMethodEnumID],[PaymMode],[PaymReference],[PaymSchedId],[PaymSpec],[PaymTermId],[PostingProfile],[PostingProfileClose],[Prepayment],[PrepaymentFlag],[ReasonRefRecId],[RECID],[RECVERSION],[ReportingCurrencyAmount],[ReportingCurrencyCrossRate],[ReportingCurrencyExchRate],[ReportingCurrencyExchRateSecondary],[ReportingExchAdjustmentRealized],[ReportingExchAdjustmentUnrealized],[RetailCustTrans],[RetailStoreId],[RetailTerminalId],[RetailTransactionId],[SettleAmount_MX],[SettleAmountCur],[SettleAmountMST],[SettleAmountReporting],[Settlement],[TaxInvoiceSalesId],[ThirdPartyBankAccountId],[TransDate],[TransType],[TransTypeEnumID],[Txt],[Voucher]
)
values (
[AccountingEvent],[AccountNum],[AmountCur],[AmountMST],[Approved],[Approver],[BankCentralBankPurposeCode],[BankCentralBankPurposeText],[BankLCExportLine],[BankRemittanceFileId],[BillOfExchangeID],[BillOfExchangeSeqNum],[BillOfExchangeStatus],[CancelledPayment],[CashDiscBaseDate],[CashDiscCode],[CashPayment],[CashPaymentFlag],[Closed],[CollectionLetter],[CollectionLetterFlag],[CollectionLetterCode],[CollectionLetterCodeEnumID],[CompanyBankAccountId],[ControlNum],[Correct],[CREATEDBY],[CREATEDDATETIME],[CREATEDTRANSACTIONID],[CredManExcludeFromCreditControl],[CurrencyCode],[CustAutomationExclude],[CustAutomationExcludeFlag],[CustAutomationPredictionSent],[CustAutomationPredictionSentFlag],[CustAutomationPredunningSent],[CustAutomationPredunningSentFlag],[CustBillingClassification],[CustExchAdjustmentRealized],[CustExchAdjustmentUnrealized],[DataAreaId],[DataLakeModified_DateTime],[DefaultDimension],[DeliveryMode],[DirectDebitMandate],[DocumentDate],[DocumentNum],[DueDate],[EUROTriangulation],[ExchAdjustment],[ExchAdjustmentReporting],[ExchRate],[ExchRateSecond],[FixedExchRate],[Interest],[Invoice],[INVOICEPROJECT],[InvoiceType_IT],[InvoiceType_ITEnumID],[LastExchAdj],[LastExchAdjRate],[LastExchAdjRateReporting],[LastExchAdjVoucher],[LastSettleAccountNum],[LastSettleCompany],[LastSettleDate],[LastSettleVoucher],[MCRPaymOrderID],[MODIFIEDBY],[MODIFIEDDATETIME],[MODIFIEDTRANSACTIONID],[OffsetRecid],[OrderAccount],[PARTITION],[PaymId],[PaymMethod],[PaymMethodEnumID],[PaymMode],[PaymReference],[PaymSchedId],[PaymSpec],[PaymTermId],[PostingProfile],[PostingProfileClose],[Prepayment],[PrepaymentFlag],[ReasonRefRecId],[RECID],[RECVERSION],[ReportingCurrencyAmount],[ReportingCurrencyCrossRate],[ReportingCurrencyExchRate],[ReportingCurrencyExchRateSecondary],[ReportingExchAdjustmentRealized],[ReportingExchAdjustmentUnrealized],[RetailCustTrans],[RetailStoreId],[RetailTerminalId],[RetailTransactionId],[SettleAmount_MX],[SettleAmountCur],[SettleAmountMST],[SettleAmountReporting],[Settlement],[TaxInvoiceSalesId],[ThirdPartyBankAccountId],[TransDate],[TransType],[TransTypeEnumID],[Txt],[Voucher]
);

end
GO
