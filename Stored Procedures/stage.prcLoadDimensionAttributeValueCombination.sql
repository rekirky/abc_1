create   proc [stage].[prcLoadDimensionAttributeValueCombination] as 
begin 
--This proc is automatically created by [etl].[prcMaterializeExternalData]

DELETE t from dbo.DimensionAttributeValueCombination t 
where exists 
	(select 1 from stage.DimensionAttributeValueCombination s 
	 where s.recid=t.recid 
		and (s.DML_Action='DELETE')
		and isnull(t.LSN,'')<isnull(s.Start_LSN,'')--delete the older record
	)

MERGE dbo.DimensionAttributeValueCombination with(tablock) as t
using (select * from blobTransInc.DimensionAttributeValueCombination where DML_Action<>'DELETE' and Instance=1) as s
on (s.recid=t.recid)
when matched then update set 
	[AccountStructure]=s.[AccountStructure],[AGREEMENT]=s.[AGREEMENT],[AGREEMENTVALUE]=s.[AGREEMENTVALUE],[BANK]=s.[BANK],[BANKVALUE]=s.[BANKVALUE],[COMMUNITYORLANDPROPERTY]=s.[COMMUNITYORLANDPROPERTY],[COMMUNITYORLANDPROPERTYVALUE]=s.[COMMUNITYORLANDPROPERTYVALUE],[COUNTY]=s.[COUNTY],[COUNTYVALUE]=s.[COUNTYVALUE],[CREATEDBY]=s.[CREATEDBY],[CREATEDDATETIME]=s.[CREATEDDATETIME],[DataAreaForCreation]=s.[DataAreaForCreation],[DataLakeModified_DateTime]=s.[DataLakeModified_DateTime],[DisplayValue]=s.[DisplayValue],[DIVISION]=s.[DIVISION],[DIVISIONVALUE]=s.[DIVISIONVALUE],[Hash]=s.[Hash],[HashVersion]=s.[HashVersion],[HashVersionEnumID]=s.[HashVersionEnumID],[ImpliedDataAreaId]=s.[ImpliedDataAreaId],[LedgerDimensionType]=s.[LedgerDimensionType],[LedgerDimensionTypeEnumID]=s.[LedgerDimensionTypeEnumID],[LEGALENTITY]=s.[LEGALENTITY],[LEGALENTITYVALUE]=s.[LEGALENTITYVALUE],[MainAccount]=s.[MainAccount],[MainAccountValue]=s.[MainAccountValue],[MODIFIEDBY]=s.[MODIFIEDBY],[MODIFIEDDATETIME]=s.[MODIFIEDDATETIME],[PARTITION]=s.[PARTITION],[PRODUCTTYPE]=s.[PRODUCTTYPE],[PRODUCTTYPEVALUE]=s.[PRODUCTTYPEVALUE],[RECID]=s.[RECID],[RECVERSION]=s.[RECVERSION],[SERIES]=s.[SERIES],[SERIESVALUE]=s.[SERIESVALUE],[SOFTWARE]=s.[SOFTWARE],[SOFTWAREVALUE]=s.[SOFTWAREVALUE],[SYSTEMGENERATEDATTRIBUTEBANKACCOUNT]=s.[SYSTEMGENERATEDATTRIBUTEBANKACCOUNT],[SYSTEMGENERATEDATTRIBUTEBANKACCOUNTVALUE]=s.[SYSTEMGENERATEDATTRIBUTEBANKACCOUNTVALUE],[SYSTEMGENERATEDATTRIBUTECUSTOMER]=s.[SYSTEMGENERATEDATTRIBUTECUSTOMER],[SYSTEMGENERATEDATTRIBUTECUSTOMERVALUE]=s.[SYSTEMGENERATEDATTRIBUTECUSTOMERVALUE],[SYSTEMGENERATEDATTRIBUTEEMPLOYEE]=s.[SYSTEMGENERATEDATTRIBUTEEMPLOYEE],[SYSTEMGENERATEDATTRIBUTEEMPLOYEE_RU]=s.[SYSTEMGENERATEDATTRIBUTEEMPLOYEE_RU],[SYSTEMGENERATEDATTRIBUTEEMPLOYEE_RUVALUE]=s.[SYSTEMGENERATEDATTRIBUTEEMPLOYEE_RUVALUE],[SYSTEMGENERATEDATTRIBUTEEMPLOYEEVALUE]=s.[SYSTEMGENERATEDATTRIBUTEEMPLOYEEVALUE],[SYSTEMGENERATEDATTRIBUTEFIXEDASSET]=s.[SYSTEMGENERATEDATTRIBUTEFIXEDASSET],[SYSTEMGENERATEDATTRIBUTEFIXEDASSETS_RU]=s.[SYSTEMGENERATEDATTRIBUTEFIXEDASSETS_RU],[SYSTEMGENERATEDATTRIBUTEFIXEDASSETS_RUVALUE]=s.[SYSTEMGENERATEDATTRIBUTEFIXEDASSETS_RUVALUE],[SYSTEMGENERATEDATTRIBUTEFIXEDASSETVALUE]=s.[SYSTEMGENERATEDATTRIBUTEFIXEDASSETVALUE],[SYSTEMGENERATEDATTRIBUTEITEM]=s.[SYSTEMGENERATEDATTRIBUTEITEM],[SYSTEMGENERATEDATTRIBUTEITEMVALUE]=s.[SYSTEMGENERATEDATTRIBUTEITEMVALUE],[SYSTEMGENERATEDATTRIBUTEPROJECT]=s.[SYSTEMGENERATEDATTRIBUTEPROJECT],[SYSTEMGENERATEDATTRIBUTEPROJECTVALUE]=s.[SYSTEMGENERATEDATTRIBUTEPROJECTVALUE],[SYSTEMGENERATEDATTRIBUTERCASH]=s.[SYSTEMGENERATEDATTRIBUTERCASH],[SYSTEMGENERATEDATTRIBUTERCASHVALUE]=s.[SYSTEMGENERATEDATTRIBUTERCASHVALUE],[SYSTEMGENERATEDATTRIBUTERDEFERRALS]=s.[SYSTEMGENERATEDATTRIBUTERDEFERRALS],[SYSTEMGENERATEDATTRIBUTERDEFERRALSVALUE]=s.[SYSTEMGENERATEDATTRIBUTERDEFERRALSVALUE],[SYSTEMGENERATEDATTRIBUTEVENDOR]=s.[SYSTEMGENERATEDATTRIBUTEVENDOR],[SYSTEMGENERATEDATTRIBUTEVENDORVALUE]=s.[SYSTEMGENERATEDATTRIBUTEVENDORVALUE]
when not matched then insert(
	[AccountStructure],[AGREEMENT],[AGREEMENTVALUE],[BANK],[BANKVALUE],[COMMUNITYORLANDPROPERTY],[COMMUNITYORLANDPROPERTYVALUE],[COUNTY],[COUNTYVALUE],[CREATEDBY],[CREATEDDATETIME],[DataAreaForCreation],[DataLakeModified_DateTime],[DisplayValue],[DIVISION],[DIVISIONVALUE],[Hash],[HashVersion],[HashVersionEnumID],[ImpliedDataAreaId],[LedgerDimensionType],[LedgerDimensionTypeEnumID],[LEGALENTITY],[LEGALENTITYVALUE],[MainAccount],[MainAccountValue],[MODIFIEDBY],[MODIFIEDDATETIME],[PARTITION],[PRODUCTTYPE],[PRODUCTTYPEVALUE],[RECID],[RECVERSION],[SERIES],[SERIESVALUE],[SOFTWARE],[SOFTWAREVALUE],[SYSTEMGENERATEDATTRIBUTEBANKACCOUNT],[SYSTEMGENERATEDATTRIBUTEBANKACCOUNTVALUE],[SYSTEMGENERATEDATTRIBUTECUSTOMER],[SYSTEMGENERATEDATTRIBUTECUSTOMERVALUE],[SYSTEMGENERATEDATTRIBUTEEMPLOYEE],[SYSTEMGENERATEDATTRIBUTEEMPLOYEE_RU],[SYSTEMGENERATEDATTRIBUTEEMPLOYEE_RUVALUE],[SYSTEMGENERATEDATTRIBUTEEMPLOYEEVALUE],[SYSTEMGENERATEDATTRIBUTEFIXEDASSET],[SYSTEMGENERATEDATTRIBUTEFIXEDASSETS_RU],[SYSTEMGENERATEDATTRIBUTEFIXEDASSETS_RUVALUE],[SYSTEMGENERATEDATTRIBUTEFIXEDASSETVALUE],[SYSTEMGENERATEDATTRIBUTEITEM],[SYSTEMGENERATEDATTRIBUTEITEMVALUE],[SYSTEMGENERATEDATTRIBUTEPROJECT],[SYSTEMGENERATEDATTRIBUTEPROJECTVALUE],[SYSTEMGENERATEDATTRIBUTERCASH],[SYSTEMGENERATEDATTRIBUTERCASHVALUE],[SYSTEMGENERATEDATTRIBUTERDEFERRALS],[SYSTEMGENERATEDATTRIBUTERDEFERRALSVALUE],[SYSTEMGENERATEDATTRIBUTEVENDOR],[SYSTEMGENERATEDATTRIBUTEVENDORVALUE]
)
values (
[AccountStructure],[AGREEMENT],[AGREEMENTVALUE],[BANK],[BANKVALUE],[COMMUNITYORLANDPROPERTY],[COMMUNITYORLANDPROPERTYVALUE],[COUNTY],[COUNTYVALUE],[CREATEDBY],[CREATEDDATETIME],[DataAreaForCreation],[DataLakeModified_DateTime],[DisplayValue],[DIVISION],[DIVISIONVALUE],[Hash],[HashVersion],[HashVersionEnumID],[ImpliedDataAreaId],[LedgerDimensionType],[LedgerDimensionTypeEnumID],[LEGALENTITY],[LEGALENTITYVALUE],[MainAccount],[MainAccountValue],[MODIFIEDBY],[MODIFIEDDATETIME],[PARTITION],[PRODUCTTYPE],[PRODUCTTYPEVALUE],[RECID],[RECVERSION],[SERIES],[SERIESVALUE],[SOFTWARE],[SOFTWAREVALUE],[SYSTEMGENERATEDATTRIBUTEBANKACCOUNT],[SYSTEMGENERATEDATTRIBUTEBANKACCOUNTVALUE],[SYSTEMGENERATEDATTRIBUTECUSTOMER],[SYSTEMGENERATEDATTRIBUTECUSTOMERVALUE],[SYSTEMGENERATEDATTRIBUTEEMPLOYEE],[SYSTEMGENERATEDATTRIBUTEEMPLOYEE_RU],[SYSTEMGENERATEDATTRIBUTEEMPLOYEE_RUVALUE],[SYSTEMGENERATEDATTRIBUTEEMPLOYEEVALUE],[SYSTEMGENERATEDATTRIBUTEFIXEDASSET],[SYSTEMGENERATEDATTRIBUTEFIXEDASSETS_RU],[SYSTEMGENERATEDATTRIBUTEFIXEDASSETS_RUVALUE],[SYSTEMGENERATEDATTRIBUTEFIXEDASSETVALUE],[SYSTEMGENERATEDATTRIBUTEITEM],[SYSTEMGENERATEDATTRIBUTEITEMVALUE],[SYSTEMGENERATEDATTRIBUTEPROJECT],[SYSTEMGENERATEDATTRIBUTEPROJECTVALUE],[SYSTEMGENERATEDATTRIBUTERCASH],[SYSTEMGENERATEDATTRIBUTERCASHVALUE],[SYSTEMGENERATEDATTRIBUTERDEFERRALS],[SYSTEMGENERATEDATTRIBUTERDEFERRALSVALUE],[SYSTEMGENERATEDATTRIBUTEVENDOR],[SYSTEMGENERATEDATTRIBUTEVENDORVALUE]
);

end
GO
